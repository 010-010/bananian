#!/bin/sh

set -e

echo "Configuring Bananian"

header () {
	printf "\e[7m%s\e[m\n" "$1"
}
error () {
	printf "\e[1;31m%s\e[m\n" "$1" 1>&2
}

packages_new=$(mktemp /tmp/bananian.packages.XXXXXX)
packages_build_new=$(mktemp /tmp/bananian.packages-build.XXXXXX)
config_new=$(mktemp /tmp/bananian.config.XXXXXX)

trap 'rm -f $packages_new $packages_build_new $config_new' HUP INT TERM

while read package; do
	case "$package" in
		"#"*)
			continue # Comment
			;;
	esac
	if [ -z "$package" ]; then continue; fi # Blank line
	packagenames=$(echo "$package" | cut -f 1)
	packagename=$(echo "$packagenames" | sed 's/,.*$//')
	packagever=$(echo "$package" | cut -f 2)
	packagesrc=$(echo "$package" | cut -f 3)
	packagearch=$(echo "$package" | cut -f 4)
	isextra=$(echo "$package" | cut -f 5)
	debname="${packagename}_${packagever}_${packagearch}.deb"
	debnames=""
	for name in $(echo "$packagenames" | sed 's/,/ /g'); do
		debnames="$debnames ${name}_${packagever}_${packagearch}.deb"
	done
	selected=0
	if [ -f ".packages" ]; then
		while read package; do
			if [ "x$packages" = "x$debnames" ]; then
				selected="1"
			fi
		done < ".packages"
	fi
	if [ -f ".packages-build" ]; then
		while read package; do
			if [ "x$(echo "$package" | cut -f 1)" = \
				"x$packagename" ];
			then
				selected="2"
			fi
		done < ".packages-build"
	fi
	case "$selected" in
		0)
			if [ "x$isextra" = "x1" ]; then
				selection_valid=1
			else
				selection_valid=0
			fi
			;;
		1|2)
			selection_valid=1
			;;
		*)
			selection_valid=0
			;;
	esac
	clear
	while true; do
		header "==>> Which packages would you like to build?"
		header "===>> Package $packagename"
		echo "Please select an option:"
		if [ "x$isextra" = "x1" ]; then
			echo " 0) don't build this package"
		fi
		echo " 1) download pre-built binaries"
		echo " 2) build from source"
		if [ "x$selection_valid" = "x1" ]; then
			echo "Current selection: $selected"
			echo "Press ENTER to keep the current selection."
		fi
		read selected_new < /dev/tty
		if [ -z "$selected_new" ]; then selected_new=$selected; fi
		case "$selected_new" in
			0)
				if [ "x$isextra" != "x1" ]; then
					clear
					error "Please select 1) or 2)"
					continue
				fi
				;;
			1)
				echo "$debnames" >> $packages_new
				;;
			2)
				echo "$debnames" >> $packages_new
				printf "$packagename\t$packagesrc\t$debname\n" \
					>> $packages_build_new
				;;
			*)
				clear
				if [ "x$isextra" = "x1" ]; then
					error "Please select 0), 1) or 2)"
				else
					error "Please select 1) or 2)"
				fi
				continue
				;;
		esac
		break
	done
done < config/packages

if [ -f .config ]; then
	hostname=$(grep '^HOSTNAME=' .config | sed 's/^HOSTNAME=//')
else
	hostname='nokia-8110-4g'
fi

echo
clear
header "==> Device Hostname"
echo "Current value: $hostname"
echo "Please enter a new value, or press ENTER to keep the current selection."
read hostname_new
if [ -z "$hostname_new" ]; then hostname_new=$hostname; fi
echo "HOSTNAME=$hostname_new" >> $config_new

[ -f .packages ] && mv .packages .packages.old
mv $packages_new .packages
[ -f .packages-build ] && mv .packages-build .packages-build.old
mv $packages_build_new .packages-build
[ -f .config ] && mv .config .config.old
mv $config_new .config

echo "Configuration complete."
