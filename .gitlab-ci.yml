image: "debian:bullseye"

build:
  stage: build
  before_script:
    - apt update && apt install cpio abootimg debootstrap pbuilder qemu-user-static -y
    - sed -i 's/^.*umount "$TARGET\/proc".*$//' /usr/share/debootstrap/functions
    - sed -i 's/CONTAINER=""/CONTAINER="docker"/' /usr/share/debootstrap/functions
  script:
    - pbuilder create --distribution bullseye
    - cp allpkgs.config .config
    - make DEBROOT=/bananian-debroot
  artifacts:
    paths:
      - '*.deb'
      - boot.img
      - debroot.tar
  interruptible: true

pages:
  stage: deploy
  script:
    - mkdir .public
    - cp -r docs/* .public
    - mkdir .public/packages-latest
    - cp *.deb .public/packages-latest/
    - mv .public public
  artifacts:
    paths:
      - public
  dependencies:
    - build
  only:
    - stable
